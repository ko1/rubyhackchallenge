# (1) MRI 開発文化の紹介

## この資料について

MRI の開発文化について紹介します。MRI: Matz Ruby Interpreter （要するに ruby コマンド）はオープンソースで 1993 年から開発が行われてきました（実際に、ソースコードが公開されたのは 1995 年 12 月です）。誰でも開発に参加して良い、ということになっていますが、何も知らないと参加は困難です。そこで、本稿ではまず、MRI の開発がどのように行われているか、笹田が把握している範囲で紹介します。

本稿で扱う内容：

* どのように MRI は開発されているか（開発フローや利用しているツールの紹介）
* （バグなどの）チケットはどのように管理されているか
* どのように MRI の中身についての情報を知るのか、それから開発コミュニティの情報を得るのか
* MRI には、どのような未解決問題が残っているのか

## MRI 開発の流れ

Ruby はオープンソースで開発されているため、誰でも開発に参加できます。

Ruby の開発と一言で言っても、次の二つを指します。

* Ruby の仕様
* MRI という Ruby インタプリタの実装

MRI は Ruby 言語のリファレンス実装として扱われているため、採用が決定された Ruby の仕様は、MRI へ搭載されます。また、バグ修正に伴って MRI の仕様が変わった場合は、それは Ruby の仕様が変更された、ということなります（そのため、バグ修正においても、互換性が無くなることに対する検討が慎重に行われています。多分）（厳密には、MRI のみに入る機能（例えば MRI のバイトコード特有の機能）もあるため、MRI の変更 == Ruby 言語の変更とは限りません）。

### リポジトリと Ruby コミッタ

Ruby のプライマリリポジトリは Subversion で管理されています <https://www.ruby-lang.org/ja/documentation/repository-guide/>。ある一定の人々がこのリポジトリを修正することができ、その人々のことを「コミッタ」と呼んでいます。現在、全世界で80人程度のコミッタがいらっしゃいます（ただし、現在アクティブに活動している人数は、もっと少ないです。過去にコミッタになると、（今のところ）コミッタを抜けることはできません。怖いですね）。

コミッタは Ruby の全ソースコードを修正することができますが、（なんとなく）担当範囲が決まっているため、担当範囲外の修正を行う場合は、担当のコミッタの意見を尊重することが求められています。例えば、笹田は現在 Ruby で利用している VM の開発者なので、VM に大きな変更を加える場合は笹田に修正を相談して欲しい、と思っています（現実的には、されないことも多いです）。

コミッタ間でのコードレビュー体制はなく、コミットされた修正を眺めて気づいたら指摘したり、問題（バグ報告等）があったときに bisect する、といった体制で開発は行われています。大きな修正では、コミッタ間でレビューを求め合ったりします。

なお、<https://github.com/ruby/ruby/> という GitHub のリポジトリにミラーがあります。

## チケット管理

仕様変更、バグ修正など、すべての議論は Redmine <https://bugs.ruby-lang.org/issues/> にチケットとしてファイルされます（されるべきです）。Ticket の登録やコメントなどは、メーリングリストに配信されます。メーリングリストには日本語向けの ruby-dev と、英語向けの ruby-core があります <https://www.ruby-lang.org/ja/community/mailing-lists/>。

仕様変更といった大事なチケットは、英語でファイルし、世界中に周知し、広く議論することを強く推奨されています。軽微な修正は、日本語でも受け付けています。日本語で議論を始めたけれど、「仕様の議論だから英語のチケットにしよう」といったことも行われています。

チケットには、大きく分けて、「機能追加要求（Feature request）」と「バグ報告（Bug report）」があります。

* Feature requests 
  * Ruby 仕様の追加や修正（Ruby 言語への要求だったり、MRI への要求だったり）。
  * ところで、Redmine の URL は `bugs` で始まってますね。
* Bug reports
  * おかしな挙動や、性能の問題といった、仕様変更以外のすべてが含まれます。

チケットを登録する際、チケットに記述する言語を英語か日本語かでドロップダウンメニューから選びます。選択した言語によって、チケットの内容を配信するメーリングリスト（ruby-core か ruby-dev）が決定されます。

良いバグ報告には、次のような内容が含まれていることが期待されます。

* Summary（問題の短いまとめ）
* 再現コードと再現環境（ruby -v の結果（必須です）、OS、コンパイラなどのバージョン、その他）
* 期待する挙動
* 実際に得られた挙動
* （可能なら）その問題を修正するためのパッチ

詳細は、英語 <https://bugs.ruby-lang.org/projects/ruby/wiki/HowToReport> (English) もしくは日本語 <https://bugs.ruby-lang.org/projects/ruby/wiki/HowToReportJa> のドキュメントがありますのでご参照ください。

良い Feature request （機能追加要求）には、次のような内容が含まれていることが期待されます。

* Abstract（提案の短いまとめ）
* Background（背景：現在、何が問題なのか、実際に困っているのは何であるか、実際のユースケースは何か）
* Proposal（提案）
* Implementation （実装：実装があれば、その提案が実現可能であるかを判断する強い証拠になります）
* Evaluation（評価：提案によって、何がどのように良くなったのか、実装があれば、その性能は十分であるか、など）
* Discussion （議論：検討するべき内容、他のアプローチとの比較など）
* Summary（まとめ）

機能追加要求では「実際にどんなユースケースがあるのか」という点が（最近だととくに）よく求められます。例えば、「使わないけど、整合性のためにはこういう仕様のほうがいいのではないか」という提案は、あまり通らないことが多いです（この場合、整合性よりも互換性のほうが優先されます）。

さらなる詳細は <https://bugs.ruby-lang.org/projects/ruby/wiki/HowToRequestFeatures> （英語）をご参照ください。

GitHub への issue および Pull request は運が良ければ対応されますが、運が悪ければ放置されます。それらを作成した場合、Redmine への issue を別途作成し、Github の当該 URL を示す、というのが良いと思います（もしくは、誰かコミッタに連絡すれば、対応してくれるかもしれません）。

## MRI における未解決問題

Ruby / MRI には、まだまだ手を付けたい問題がたくさんあります。下記にいくつかあげておきます。

* 仕様の議論
  * Ruby 2.x (2.5, ...)
  * Ruby 3
    * JIT compilation (only for performance? drop backward compatibility?)
    * Static checking
    * Concurrent execution
* 性能改善
  * ベンチマークの整備
  * 性能改善
* ドキュメンテーション
* バグ修正

最近笹田がなんとかしたいと思っている問題（インターナルが多い）もあげておきます。

* バイトコードシリアライザの性能・品質向上
* メソッド呼び出しの仕組み変更による高速化
* コードのインライン化の対応
* 世代別 GC 対応オブジェクトを増やして性能向上
* 世間の gem を Ruby の CI でテストする仕組みの用意

## Ruby 開発の情報

### MRI インターナルをハックするための情報

[参考文献](./bib.md) をご参照ください。
また、深くハックする場合は、C 言語の知識が必要になります。

### コミュニケーションチャンネル

* Ruby's redmine: https://bugs.ruby-lang.org/projects/ruby/
    * Ticket
    * Wiki
* Mailing list
    * https://www.ruby-lang.org/en/community/mailing-lists/ (En) https://www.ruby-lang.org/ja/community/mailing-lists/ (Ja)
    * ruby-core (English)
    * ruby-dev (Japanese)
* Conference, meetup
    * RubyConf and other international conferences（ほぼ、英語で議論しています）
    * 日本国内
        * RubyKaigi
        * RegionalRubyKaigi
        * Asakusa.rb, *.rb
* Ruby 開発者会議
    * 毎月、東京のどこかで行っています。
* 個人へのコンタクト
    * Twitter
        * @yukihiro_matz
        * ...
* Gitter <https://gitter.im/ruby/ruby>
  * これを機に作りました。

## 大切なこと

本稿では、いくつか面倒そうなルール的なことを書きましたが、我々 Ruby インタプリタ開発者が最も重視しているのは「ハッキング」です。
もし、偉大なパッチを寄贈してくださるのであれば、多少ルールからそれても、全力でサポートします（もしくは、全力で議論します）。

コードを書きましょう。
